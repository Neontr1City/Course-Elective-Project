# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'optimal.ui'
#
# Created by: PyQt5 UI code generator 5.15.11
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtCore import Qt
from PyQt5.QtWidgets import QMessageBox
import os
import random
from config import UI_CONFIG
from extract_courses import extract_courses_by_grade_and_major, has_time_conflict

# å¯¼å…¥ä¸»ç¨‹åºçš„ç”¨æˆ·æ•°æ®
try:
    from main_enhanced import user_data
except ImportError:
    user_data = {"compulsory_courses": [], "optional_compulsory_courses": []}

class Ui_Dialog(object):
    def setupUi(self, Dialog):
        Dialog.setObjectName("Dialog")
        Dialog.resize(833, 748)
        
        # åº”ç”¨ç»Ÿä¸€æ ·å¼
        Dialog.setStyleSheet(UI_CONFIG['component_styles']['dialog'])
        
        # è·å–å½“å‰è„šæœ¬æ‰€åœ¨ç›®å½•
        base_dir = os.path.dirname(os.path.abspath(__file__))
        res_dir = os.path.join(base_dir, "res")
        
        # æ ‡é¢˜æŒ‰é’®
        self.pushButton_2 = QtWidgets.QPushButton(Dialog)
        self.pushButton_2.setGeometry(QtCore.QRect(250, 50, 300, 80))
        self.pushButton_2.setObjectName("pushButton_2")
        self.pushButton_2.setText("é€šè¯†è¯¾é€‰æ‹©")  # ç›´æ¥è®¾ç½®æ ‡é¢˜æ–‡å­—
        self.pushButton_2.setStyleSheet("""
            QPushButton {
                background-color: #ffffff;
                border: 2px solid #000000;
                border-radius: 15px;
                color: #000000;
                font-family: 'æ¥·ä½“';
                font-size: 24px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #f0f0f0;
            }
        """)
        
        # ç¡®è®¤æŒ‰é’®
        self.confirm = QtWidgets.QPushButton(Dialog)
        self.confirm.setGeometry(QtCore.QRect(600, 690, 120, 35))
        self.confirm.setObjectName("confirm")
        self.confirm.setText("ç¡®è®¤")  # ç›´æ¥è®¾ç½®æŒ‰é’®æ–‡å­—
        self.confirm.setStyleSheet("""
            QPushButton {
                background-color: #ffffff;
                border: 2px solid #000000;
                border-radius: 5px;
                padding: 8px 16px;
                font-family: 'æ¥·ä½“';
                font-size: 16px;
                font-weight: bold;
                color: #000000;
            }
            QPushButton:hover {
                background-color: #f0f0f0;
            }
        """)
        
        # è¿”å›æŒ‰é’®
        self.back = QtWidgets.QPushButton(Dialog)
        self.back.setGeometry(QtCore.QRect(30, 690, 120, 35))
        self.back.setObjectName("back")
        self.back.setText("è¿”å›")  # ç›´æ¥è®¾ç½®æŒ‰é’®æ–‡å­—
        self.back.setStyleSheet("""
            QPushButton {
                background-color: #ffffff;
                border: 2px solid #000000;
                border-radius: 5px;
                padding: 8px 16px;
                font-family: 'æ¥·ä½“';
                font-size: 16px;
                font-weight: bold;
                color: #000000;
            }
            QPushButton:hover {
                background-color: #f0f0f0;
            }
        """)
        
        # èƒŒæ™¯
        self.background = QtWidgets.QLabel(Dialog)
        self.background.setGeometry(QtCore.QRect(0, 0, 871, 751))
        self.background.setText("")
        if os.path.exists(os.path.join(res_dir, "èƒŒæ™¯.png")):
            self.background.setPixmap(QtGui.QPixmap(os.path.join(res_dir, "èƒŒæ™¯.png")))
        self.background.setObjectName("background")
        
        # æ¨èä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
        self.textBrowser = QtWidgets.QTextBrowser(Dialog)
        self.textBrowser.setGeometry(QtCore.QRect(50, 170, 280, 400))
        self.textBrowser.setObjectName("textBrowser")
        self.textBrowser.setStyleSheet(UI_CONFIG['component_styles']['text_browser'])
        
        # å­¦åˆ†æ˜¾ç¤ºåŒºåŸŸå¸ƒå±€è°ƒæ•´
        # èƒŒæ™¯æŒ‰é’®
        self.pushButton_4 = QtWidgets.QPushButton(Dialog)
        self.pushButton_4.setGeometry(QtCore.QRect(280, 690, 280, 51))
        self.pushButton_4.setText("")
        self.pushButton_4.setObjectName("pushButton_4")
        self.pushButton_4.setStyleSheet(UI_CONFIG['component_styles']['credits_display']['background'])
        
        # å­¦åˆ†æ ‡ç­¾ - è°ƒæ•´ä¸ºå·¦å¯¹é½ï¼Œä¸ºæ•°å­—ç•™å‡ºç©ºé—´
        self.label = QtWidgets.QLabel(Dialog)
        self.label.setGeometry(QtCore.QRect(290, 680, 100, 71))  # å‡å°å®½åº¦ï¼Œåªå®¹çº³æ–‡å­—
        self.label.setObjectName("label")
        self.label.setAlignment(Qt.AlignLeft | Qt.AlignVCenter)  # å·¦å¯¹é½ï¼Œå‚ç›´å±…ä¸­
        self.label.setStyleSheet(UI_CONFIG['component_styles']['credits_display']['label'])
        
        # å­¦åˆ†æ˜¾ç¤º - ç§»åˆ°æ ‡ç­¾å³ä¾§
        self.all_points = QtWidgets.QLCDNumber(Dialog)
        self.all_points.setGeometry(QtCore.QRect(390, 690, 160, 51))  # è°ƒæ•´ä½ç½®åˆ°æ ‡ç­¾å³ä¾§
        self.all_points.setObjectName("all_points")
        self.all_points.setStyleSheet(UI_CONFIG['component_styles']['credits_display']['lcd'])
        self.all_points.setDigitCount(4)  # è®¾ç½®æ˜¾ç¤ºä½æ•°
        self.all_points.setSegmentStyle(QtWidgets.QLCDNumber.Flat)  # è®¾ç½®æ˜¾ç¤ºé£æ ¼
        
        # å­¦åˆ†æ˜¾ç¤ºèƒŒæ™¯
        self.credits_background = QtWidgets.QPushButton(Dialog)
        self.credits_background.setGeometry(QtCore.QRect(280, 680, 280, 71))
        self.credits_background.setObjectName("credits_background")
        self.credits_background.setStyleSheet(UI_CONFIG['component_styles']['credits_display']['background'])
        
        # è¯¾ç¨‹åˆ—è¡¨è¡¨æ ¼
        self.list = QtWidgets.QTableWidget(Dialog)
        self.list.setGeometry(QtCore.QRect(350, 170, 300, 400))
        self.list.setObjectName("list")
        self.list.setColumnCount(4)
        self.list.setStyleSheet(UI_CONFIG['component_styles']['table'])
        
        # è®¾ç½®è¡¨å¤´
        headers = ["è¯¾ç¨‹åç§°", "å­¦åˆ†", "æ—¶é—´", "æ¨è"]
        for i, header in enumerate(headers):
            item = QtWidgets.QTableWidgetItem()
            item.setText(header)
            self.list.setHorizontalHeaderItem(i, item)
        
        # å¤é€‰æ¡†åŒºåŸŸ - ä½¿ç”¨æ»šåŠ¨åŒºåŸŸ
        self.checkbox_widget = QtWidgets.QWidget(Dialog)
        self.checkbox_widget.setGeometry(QtCore.QRect(670, 170, 150, 400))
        
        self.scroll_area = QtWidgets.QScrollArea(self.checkbox_widget)
        self.scroll_area.setGeometry(QtCore.QRect(0, 0, 150, 400))
        self.scroll_area.setWidgetResizable(True)
        self.scroll_area.setStyleSheet("""
            QScrollArea {
                border: 2px solid #000000;
                border-radius: 10px;
                background-color: #ffffff;
            }
        """)
        
        self.scroll_content = QtWidgets.QWidget()
        self.scroll_area.setWidget(self.scroll_content)
        
        self.checkbox_layout = QtWidgets.QVBoxLayout(self.scroll_content)
        self.checkbox_layout.setContentsMargins(10, 10, 10, 10)
        self.checkbox_layout.setSpacing(8)
        
        # å¤é€‰æ¡†åˆ—è¡¨å°†åŠ¨æ€åˆ›å»º
        self.checkboxes = []
        
        # è®¾ç½®z-order
        self.background.raise_()
        self.list.raise_()
        self.pushButton_4.raise_()
        self.pushButton_2.raise_()
        self.confirm.raise_()
        self.textBrowser.raise_()
        self.all_points.raise_()
        self.label.raise_()
        self.back.raise_()
        self.checkbox_widget.raise_()

    def retranslateUi(self, Dialog):
        _translate = QtCore.QCoreApplication.translate
        Dialog.setWindowTitle(_translate("Dialog", "é€šè¯†è¯¾é€‰æ‹©"))
        
        # è®¾ç½®æ ‡é¢˜æŒ‰é’®æ–‡å­—
        self.pushButton_2.setText(_translate("Dialog", "é€šè¯†è¯¾é€‰æ‹©"))
        
        # è®¾ç½®ç¡®è®¤å’Œè¿”å›æŒ‰é’®æ–‡å­—
        self.confirm.setText(_translate("Dialog", "ç¡®è®¤"))
        self.back.setText(_translate("Dialog", "è¿”å›"))
        
        # è®¾ç½®å­¦åˆ†æ ‡ç­¾æ–‡å­—
        label_font = QtGui.QFont()
        label_font.setFamily("æ¥·ä½“")
        label_font.setPointSize(18)
        label_font.setBold(True)
        self.label.setFont(label_font)
        self.label.setText(_translate("Dialog", "å·²é€‰å­¦åˆ†"))

class OptimalDialog(QtWidgets.QDialog, Ui_Dialog):
    def __init__(self, grade, major, parent=None):
        super().__init__(parent)
        self.setupUi(self)
        self.grade = grade
        self.major = major
        self.courses = []
        self.selected_courses = []
        self.existing_courses = []  # å·²é€‰è¯¾ç¨‹åˆ—è¡¨ï¼ˆç”¨äºæ—¶é—´å†²çªæ£€æŸ¥ï¼‰
        
        # è·å–å·²é€‰æ‹©çš„å¿…ä¿®è¯¾å’Œé€‰æ‹©æ€§å¿…ä¿®è¯¾
        self.load_existing_courses()
        
        # è¿æ¥ä¿¡å·
        self.confirm.clicked.connect(self.confirm_selection)
        self.back.clicked.connect(self.reject)
        
        # åŠ è½½è¯¾ç¨‹å¹¶è¿›è¡Œæ™ºèƒ½æ¨è
        self.load_courses()
        
        # åˆå§‹åŒ–æ˜¾ç¤ºå·²æœ‰å­¦åˆ†
        self.update_selection()

    def load_existing_courses(self):
        """åŠ è½½å·²é€‰æ‹©çš„è¯¾ç¨‹ï¼ˆç”¨äºæ—¶é—´å†²çªæ£€æŸ¥ï¼‰"""
        try:
            # ä»user_dataè·å–å·²é€‰è¯¾ç¨‹
            self.existing_courses = []
            
            # æ·»åŠ å¿…ä¿®è¯¾
            for course in user_data.get("compulsory_courses", []):
                if course.get('time'):
                    self.existing_courses.append({
                        'name': course['name'],
                        'time': course['time'],
                        'type': 'å¿…ä¿®è¯¾'
                    })
            
            # æ·»åŠ é€‰æ‹©æ€§å¿…ä¿®è¯¾
            for course in user_data.get("optional_compulsory_courses", []):
                if course.get('time'):
                    self.existing_courses.append({
                        'name': course['name'],
                        'time': course['time'],
                        'type': 'é€‰æ‹©æ€§å¿…ä¿®è¯¾'
                    })
            
            print(f"å·²é€‰è¯¾ç¨‹æ•°é‡: {len(self.existing_courses)}")
            
        except Exception as e:
            print(f"åŠ è½½å·²é€‰è¯¾ç¨‹å¤±è´¥: {e}")
            self.existing_courses = []

    def load_courses(self):
        """åŠ è½½é€šè¯†è¯¾ç¨‹å¹¶è¿›è¡Œæ™ºèƒ½æ¨è"""
        try:
            # ç”Ÿæˆç¤ºä¾‹é€šè¯†è¯¾ç¨‹æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­åº”ä»æ•°æ®åº“æˆ–æ–‡ä»¶è¯»å–ï¼‰
            sample_courses = [
                {"è¯¾ç¨‹åç§°": "å¤§å­¦è‹±è¯­", "å­¦åˆ†": 2, "ä¸Šè¯¾æ—¶é—´": "å‘¨ä¸€3-4èŠ‚", "æ•™å¸ˆ": "ææ•™æˆ", "ç±»å‹": "è¯­è¨€ç±»"},
                {"è¯¾ç¨‹åç§°": "ä¸­å›½æ–‡å­¦ç»å…¸", "å­¦åˆ†": 3, "ä¸Šè¯¾æ—¶é—´": "å‘¨äºŒ1-2èŠ‚", "æ•™å¸ˆ": "ç‹æ•™æˆ", "ç±»å‹": "æ–‡å­¦ç±»"},
                {"è¯¾ç¨‹åç§°": "ä¸–ç•Œå†å²æ¦‚è®º", "å­¦åˆ†": 2, "ä¸Šè¯¾æ—¶é—´": "å‘¨ä¸‰5-6èŠ‚", "æ•™å¸ˆ": "å¼ æ•™æˆ", "ç±»å‹": "å†å²ç±»"},
                {"è¯¾ç¨‹åç§°": "è‰ºæœ¯æ¬£èµ", "å­¦åˆ†": 2, "ä¸Šè¯¾æ—¶é—´": "å‘¨å››7-8èŠ‚", "æ•™å¸ˆ": "èµµæ•™æˆ", "ç±»å‹": "è‰ºæœ¯ç±»"},
                {"è¯¾ç¨‹åç§°": "å¿ƒç†å­¦å¯¼è®º", "å­¦åˆ†": 3, "ä¸Šè¯¾æ—¶é—´": "å‘¨äº”3-4èŠ‚", "æ•™å¸ˆ": "é™ˆæ•™æˆ", "ç±»å‹": "å¿ƒç†ç±»"},
                {"è¯¾ç¨‹åç§°": "ç¯å¢ƒç§‘å­¦æ¦‚è®º", "å­¦åˆ†": 2, "ä¸Šè¯¾æ—¶é—´": "å‘¨ä¸€7-8èŠ‚", "æ•™å¸ˆ": "åˆ˜æ•™æˆ", "ç±»å‹": "ç§‘å­¦ç±»"},
                {"è¯¾ç¨‹åç§°": "ç»æµå­¦åŸç†", "å­¦åˆ†": 3, "ä¸Šè¯¾æ—¶é—´": "å‘¨äºŒ5-6èŠ‚", "æ•™å¸ˆ": "å­™æ•™æˆ", "ç±»å‹": "ç»æµç±»"},
                {"è¯¾ç¨‹åç§°": "å“²å­¦æ€æƒ³å²", "å­¦åˆ†": 2, "ä¸Šè¯¾æ—¶é—´": "å‘¨ä¸‰1-2èŠ‚", "æ•™å¸ˆ": "å‘¨æ•™æˆ", "ç±»å‹": "å“²å­¦ç±»"},
                {"è¯¾ç¨‹åç§°": "ä½“è‚²å¥åº·", "å­¦åˆ†": 1, "ä¸Šè¯¾æ—¶é—´": "å‘¨å››3-4èŠ‚", "æ•™å¸ˆ": "å´æ•™æˆ", "ç±»å‹": "ä½“è‚²ç±»"},
                {"è¯¾ç¨‹åç§°": "éŸ³ä¹æ¬£èµ", "å­¦åˆ†": 2, "ä¸Šè¯¾æ—¶é—´": "å‘¨äº”1-2èŠ‚", "æ•™å¸ˆ": "éƒ‘æ•™æˆ", "ç±»å‹": "è‰ºæœ¯ç±»"},
                {"è¯¾ç¨‹åç§°": "æ•°å­¦æ€ç»´", "å­¦åˆ†": 3, "ä¸Šè¯¾æ—¶é—´": "å‘¨ä¸€1-2èŠ‚", "æ•™å¸ˆ": "é©¬æ•™æˆ", "ç±»å‹": "æ•°å­¦ç±»"},
                {"è¯¾ç¨‹åç§°": "ç¤¾ä¼šå­¦æ¦‚è®º", "å­¦åˆ†": 2, "ä¸Šè¯¾æ—¶é—´": "å‘¨äºŒ7-8èŠ‚", "æ•™å¸ˆ": "å†¯æ•™æˆ", "ç±»å‹": "ç¤¾ä¼šç±»"},
            ]
            
            # è¿›è¡Œæ™ºèƒ½ç­›é€‰ï¼Œæ¨èæ—¶é—´ä¸å†²çªçš„è¯¾ç¨‹
            recommended_courses = self.smart_course_recommendation(sample_courses)
            
            self.courses = recommended_courses
            self.update_course_display()
            self.show_recommendation_info()
            
        except Exception as e:
            print(f"åŠ è½½è¯¾ç¨‹å¤±è´¥: {e}")
            self.courses = []

    def smart_course_recommendation(self, all_courses):
        """æ™ºèƒ½æ¨èæ—¶é—´ä¸å†²çªçš„è¯¾ç¨‹"""
        recommended = []
        conflict_courses = []
        
        for course in all_courses:
            course_time = course.get('ä¸Šè¯¾æ—¶é—´', '')
            has_conflict = False
            
            # æ£€æŸ¥ä¸å·²é€‰è¯¾ç¨‹çš„æ—¶é—´å†²çª
            for existing in self.existing_courses:
                if self.check_time_conflict(course_time, existing['time']):
                    has_conflict = True
                    conflict_courses.append({
                        'course': course,
                        'conflict_with': existing['name'],
                        'conflict_type': existing['type']
                    })
                    break
            
            if not has_conflict:
                course['recommended'] = True
                recommended.append(course)
            else:
                course['recommended'] = False
                recommended.append(course)
        
        # æŒ‰æ¨èä¼˜å…ˆçº§æ’åºï¼ˆæ¨èçš„åœ¨å‰é¢ï¼‰
        recommended.sort(key=lambda x: (not x['recommended'], x['è¯¾ç¨‹åç§°']))
        
        return recommended

    def check_time_conflict(self, time1, time2):
        """æ£€æŸ¥ä¸¤ä¸ªæ—¶é—´æ˜¯å¦å†²çª"""
        if not time1 or not time2:
            return False
        
        try:
            # ç®€å•çš„æ—¶é—´å†²çªæ£€æŸ¥é€»è¾‘
            # æå–æ˜ŸæœŸå‡ å’ŒèŠ‚æ¬¡ä¿¡æ¯
            def parse_time(time_str):
                time_str = str(time_str).strip()
                if 'å‘¨' in time_str and 'èŠ‚' in time_str:
                    # æå–æ˜ŸæœŸ
                    weekday = ''
                    if 'å‘¨ä¸€' in time_str: weekday = 'å‘¨ä¸€'
                    elif 'å‘¨äºŒ' in time_str: weekday = 'å‘¨äºŒ'
                    elif 'å‘¨ä¸‰' in time_str: weekday = 'å‘¨ä¸‰'
                    elif 'å‘¨å››' in time_str: weekday = 'å‘¨å››'
                    elif 'å‘¨äº”' in time_str: weekday = 'å‘¨äº”'
                    elif 'å‘¨å…­' in time_str: weekday = 'å‘¨å…­'
                    elif 'å‘¨æ—¥' in time_str: weekday = 'å‘¨æ—¥'
                    
                    # æå–èŠ‚æ¬¡
                    periods = []
                    if '1' in time_str: periods.append(1)
                    if '2' in time_str: periods.append(2)
                    if '3' in time_str: periods.append(3)
                    if '4' in time_str: periods.append(4)
                    if '5' in time_str: periods.append(5)
                    if '6' in time_str: periods.append(6)
                    if '7' in time_str: periods.append(7)
                    if '8' in time_str: periods.append(8)
                    
                    return weekday, set(periods)
                return '', set()
            
            weekday1, periods1 = parse_time(time1)
            weekday2, periods2 = parse_time(time2)
            
            # å¦‚æœæ˜¯åŒä¸€å¤©ä¸”æ—¶é—´æ®µæœ‰é‡å ï¼Œåˆ™å†²çª
            if weekday1 == weekday2 and weekday1 and periods1 & periods2:
                return True
            
            return False
            
        except Exception as e:
            print(f"æ—¶é—´å†²çªæ£€æŸ¥å¤±è´¥: {e}")
            return False

    def update_course_display(self):
        """æ›´æ–°è¯¾ç¨‹æ˜¾ç¤º"""
        if not self.courses:
            return
        
        # æ¸…ç©ºç°æœ‰å¤é€‰æ¡†
        for checkbox in self.checkboxes:
            checkbox.deleteLater()
        self.checkboxes.clear()
        
        # æ›´æ–°è¡¨æ ¼
        self.list.setRowCount(len(self.courses))
        
        for i, course in enumerate(self.courses):
            # è¡¨æ ¼æ˜¾ç¤º
            name_item = QtWidgets.QTableWidgetItem(course['è¯¾ç¨‹åç§°'])
            credit_item = QtWidgets.QTableWidgetItem(str(course['å­¦åˆ†']))
            time_item = QtWidgets.QTableWidgetItem(course.get('ä¸Šè¯¾æ—¶é—´', ''))
            
            # æ¨èçŠ¶æ€
            if course.get('recommended', False):
                recommend_item = QtWidgets.QTableWidgetItem("æ¨è")
                recommend_item.setBackground(QtGui.QColor(144, 238, 144))  # æµ…ç»¿è‰²
                name_item.setBackground(QtGui.QColor(144, 238, 144))
                credit_item.setBackground(QtGui.QColor(144, 238, 144))
                time_item.setBackground(QtGui.QColor(144, 238, 144))
            else:
                recommend_item = QtWidgets.QTableWidgetItem("å†²çª")
                recommend_item.setBackground(QtGui.QColor(255, 182, 193))  # æµ…çº¢è‰²
                name_item.setBackground(QtGui.QColor(255, 182, 193))
                credit_item.setBackground(QtGui.QColor(255, 182, 193))
                time_item.setBackground(QtGui.QColor(255, 182, 193))
            
            self.list.setItem(i, 0, name_item)
            self.list.setItem(i, 1, credit_item)
            self.list.setItem(i, 2, time_item)
            self.list.setItem(i, 3, recommend_item)
            
            # åˆ›å»ºå¤é€‰æ¡†
            checkbox = QtWidgets.QCheckBox(self.scroll_content)
            checkbox.setText(f"{course['è¯¾ç¨‹åç§°']} ({course['å­¦åˆ†']}åˆ†)")
            checkbox.setStyleSheet(UI_CONFIG['component_styles']['checkbox'])
            
            # æ¨èè¯¾ç¨‹ç”¨ä¸åŒé¢œè‰²æ˜¾ç¤ºï¼Œä½†ä¸è‡ªåŠ¨å‹¾é€‰
            if course.get('recommended', False):
                checkbox.setStyleSheet(UI_CONFIG['component_styles']['checkbox'] + """
                    QCheckBox {
                        font-weight: bold;
                        color: #4CAF50;
                    }
                """)
            
            checkbox.stateChanged.connect(self.update_selection)
            self.checkboxes.append(checkbox)
            self.checkbox_layout.addWidget(checkbox)
        
        # è°ƒæ•´è¡¨æ ¼åˆ—å®½
        self.list.resizeColumnsToContents()
        
        # æ›´æ–°å­¦åˆ†æ˜¾ç¤º
        self.update_selection()

    def show_recommendation_info(self):
        """æ˜¾ç¤ºæ¨èä¿¡æ¯"""
        try:
            recommended_count = len([c for c in self.courses if c.get('recommended', False)])
            conflict_count = len(self.courses) - recommended_count
            
            info_html = f"""
            <h3 style='color: #2196F3; font-family: æ¥·ä½“;'>ğŸ“š é€šè¯†è¯¾æ¨è</h3>
            <p style='font-family: æ¥·ä½“;'><strong>æ¨èç­–ç•¥ï¼š</strong>ä¼˜å…ˆé€‰æ‹©ä¸å·²é€‰è¯¾ç¨‹æ—¶é—´ä¸å†²çªçš„è¯¾ç¨‹</p>
            <p style='font-family: æ¥·ä½“;'><strong>æ¨èè¯¾ç¨‹ï¼š</strong>{recommended_count} é—¨</p>
            <p style='font-family: æ¥·ä½“;'><strong>æ—¶é—´å†²çªï¼š</strong>{conflict_count} é—¨</p>
            
            <h4 style='color: #4CAF50; font-family: æ¥·ä½“;'>âœ… æ¨èè¯¾ç¨‹</h4>
            """
            
            for course in self.courses:
                if course.get('recommended', False):
                    info_html += f"""
                    <div style='margin: 5px 0; padding: 5px; background-color: #f0f8f0; border-radius: 3px; font-family: æ¥·ä½“;'>
                        <strong>{course['è¯¾ç¨‹åç§°']}</strong><br>
                        æ—¶é—´: {course.get('ä¸Šè¯¾æ—¶é—´', '')}<br>
                        å­¦åˆ†: {course['å­¦åˆ†']}
                    </div>
                    """
            
            if conflict_count > 0:
                info_html += f"<h4 style='color: #f44336; font-family: æ¥·ä½“;'>âš ï¸ æ—¶é—´å†²çªè¯¾ç¨‹</h4>"
                for course in self.courses:
                    if not course.get('recommended', False):
                        info_html += f"""
                        <div style='margin: 5px 0; padding: 5px; background-color: #fff0f0; border-radius: 3px; font-family: æ¥·ä½“;'>
                            <strong>{course['è¯¾ç¨‹åç§°']}</strong><br>
                            æ—¶é—´: {course.get('ä¸Šè¯¾æ—¶é—´', '')}<br>
                            <span style='color: #f44336;'>ä¸å·²é€‰è¯¾ç¨‹æ—¶é—´å†²çª</span>
                        </div>
                        """
            
            self.textBrowser.setHtml(info_html)
            
        except Exception as e:
            print(f"æ˜¾ç¤ºæ¨èä¿¡æ¯å¤±è´¥: {e}")
            self.textBrowser.setHtml("<p style='font-family: æ¥·ä½“;'>æ¨èä¿¡æ¯åŠ è½½å¤±è´¥</p>")

    def update_selection(self):
        """æ›´æ–°é€‰æ‹©çŠ¶æ€"""
        current_selection_credits = 0
        selected_count = 0
        
        for i, checkbox in enumerate(self.checkboxes):
            if checkbox.isChecked():
                current_selection_credits += self.courses[i]['å­¦åˆ†']
                selected_count += 1
        
        # è·å–å·²æœ‰çš„å¿…ä¿®è¯¾å’Œé€‰æ‹©æ€§å¿…ä¿®è¯¾å­¦åˆ†
        try:
            from main_enhanced import user_data
            existing_credits = user_data.get("total_credits", 0)
            total_display_credits = existing_credits + current_selection_credits
        except:
            total_display_credits = current_selection_credits
        
        # æ˜¾ç¤ºç´¯ç§¯å­¦åˆ†
        self.all_points.display(total_display_credits)
        self.label.setText("ç´¯ç§¯å­¦åˆ†")  # ç®€åŒ–æ ‡ç­¾æ–‡å­—ï¼Œä¸ºæ•°å­—ç•™å‡ºæ›´å¤šç©ºé—´

    def confirm_selection(self):
        """ç¡®è®¤é€‰æ‹©"""
        self.selected_courses = []
        
        for i, checkbox in enumerate(self.checkboxes):
            if checkbox.isChecked():
                course = self.courses[i].copy()
                self.selected_courses.append(course)
        
        if not self.selected_courses:
            QMessageBox.warning(self, "æç¤º", "è¯·è‡³å°‘é€‰æ‹©ä¸€é—¨é€šè¯†è¯¾ç¨‹ï¼")
            return
        
        print(f"ç¡®è®¤é€‰æ‹©äº†{len(self.selected_courses)}é—¨é€šè¯†è¯¾ç¨‹")
        for course in self.selected_courses:
            print(f"- {course['è¯¾ç¨‹åç§°']} ({course['å­¦åˆ†']}åˆ†)")
        
        # ä¿å­˜é€šè¯†è¯¾ç»“æœåˆ°å…¨å±€æ•°æ®å¹¶ç´¯ç§¯å­¦åˆ†
        try:
            from main_enhanced import user_data
            
            formatted_general = []
            for course in self.selected_courses:
                formatted_general.append({
                    'name': course.get('è¯¾ç¨‹åç§°', ''),
                    'credit': float(course.get('å­¦åˆ†', 0)),
                    'time': course.get('ä¸Šè¯¾æ—¶é—´', ''),
                    'location': course.get('ä¸Šè¯¾åœ°ç‚¹', ''),
                    'teacher': course.get('æ•™å¸ˆ', '')
                })
            
            # ä¿å­˜åˆ°å…¨å±€æ•°æ®
            user_data["general_courses"] = formatted_general
            
            # ç´¯ç§¯å­¦åˆ†ï¼ˆåŠ åˆ°å·²æœ‰çš„å¿…ä¿®è¯¾å’Œé€‰æ‹©æ€§å¿…ä¿®è¯¾å­¦åˆ†ä¸Šï¼‰
            general_credits = sum(course['credit'] for course in formatted_general)
            user_data["total_credits"] += general_credits
            
            print(f"é€šè¯†è¯¾å®Œæˆï¼Œæ–°å¢å­¦åˆ†: {general_credits}")
            print(f"æœ€ç»ˆç´¯ç§¯æ€»å­¦åˆ†: {user_data['total_credits']}")
            
            # è·³è½¬åˆ°AIæ™ºèƒ½åˆ†æè¯„ä¼°
            from evaluation import Ui_Dialog as EvaluationUi
            from PyQt5 import QtWidgets
            
            evaluation_dialog = QtWidgets.QDialog()
            evaluation_ui = EvaluationUi()
            evaluation_ui.setupUi(evaluation_dialog)
            
            # åˆ›å»ºè¯„ä¼°å¯¹è¯æ¡†å®ä¾‹
            from main_enhanced import EvaluationDialog
            evaluation_instance = EvaluationDialog()
            
            # å…³é—­å½“å‰ç•Œé¢å¹¶æ˜¾ç¤ºAIåˆ†æç•Œé¢
            self.accept()
            evaluation_instance.exec_()
            
        except Exception as e:
            print(f"ä¿å­˜é€šè¯†è¯¾ç»“æœæˆ–è·³è½¬å¤±è´¥: {e}")
            self.accept()

    def get_selected_courses(self):
        """è·å–é€‰ä¸­çš„è¯¾ç¨‹"""
        return [
            {
                'è¯¾ç¨‹åç§°': course['è¯¾ç¨‹åç§°'],
                'å­¦åˆ†': course['å­¦åˆ†'],
                'ä¸Šè¯¾æ—¶é—´': course.get('ä¸Šè¯¾æ—¶é—´', ''),
                'ä¸Šè¯¾åœ°ç‚¹': course.get('ä¸Šè¯¾åœ°ç‚¹', ''),
                'æ•™å¸ˆ': course.get('æ•™å¸ˆ', ''),
                'ç±»å‹': course.get('ç±»å‹', 'é€šè¯†è¯¾')
            }
            for course in self.selected_courses
        ]
