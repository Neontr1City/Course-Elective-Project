# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'final.ui'
#
# Created by: PyQt5 UI code generator 5.15.11
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets
import os
from config import UI_CONFIG
import pandas as pd
from datetime import datetime
from course_scheduler import CourseScheduler, create_course_from_dict

# ç”¨æˆ·æ•°æ®å°†åœ¨è¿è¡Œæ—¶åŠ¨æ€è·å–ï¼Œé¿å…å¾ªç¯å¯¼å…¥
user_data = None

def get_user_data():
    """åŠ¨æ€è·å–ç”¨æˆ·æ•°æ®ï¼Œé¿å…å¾ªç¯å¯¼å…¥"""
    global user_data
    if user_data is None:
        try:
            import main_enhanced
            user_data = main_enhanced.user_data
            print(f"Final.py - æˆåŠŸå¯¼å…¥ç”¨æˆ·æ•°æ®: {dict(user_data)}")
        except (ImportError, AttributeError) as e:
            print(f"Final.py - å¯¼å…¥ç”¨æˆ·æ•°æ®å¤±è´¥: {e}ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®")
            user_data = {
                "compulsory_courses": [],
                "optional_compulsory_courses": [],
                "general_courses": [],
                "total_credits": 0,
                "age": "æœªçŸ¥",
                "major": "æœªçŸ¥"
            }
    return user_data

class Ui_Dialog(object):
    def setupUi(self, Dialog):
        Dialog.setObjectName("Dialog")
        Dialog.resize(900, 700)
        
        # åº”ç”¨ç»Ÿä¸€æ ·å¼
        Dialog.setStyleSheet(UI_CONFIG['component_styles']['dialog'])
        
        # ä¸»å¸ƒå±€
        self.gridLayout = QtWidgets.QGridLayout(Dialog)
        self.gridLayout.setObjectName("gridLayout")
        
        # æ ‡é¢˜
        self.title_label = QtWidgets.QLabel(Dialog)
        self.title_label.setGeometry(QtCore.QRect(250, 20, 400, 50))
        self.title_label.setObjectName("title_label")
        self.title_label.setAlignment(QtCore.Qt.AlignCenter)
        self.title_label.setText("ğŸ“… æœ€ç»ˆè¯¾ç¨‹è¡¨")
        self.title_label.setStyleSheet("""
            QLabel {
                font-family: 'æ¥·ä½“';
                font-size: 24px;
                font-weight: bold;
                color: #1A237E;
                background-color: #ffffff;
                border: 2px solid #3F51B5;
                border-radius: 15px;
                padding: 10px;
            }
        """)
        
        # å­¦ç”Ÿä¿¡æ¯åŒºåŸŸ
        self.info_frame = QtWidgets.QFrame(Dialog)
        self.info_frame.setGeometry(QtCore.QRect(50, 80, 800, 80))
        self.info_frame.setStyleSheet("""
            QFrame {
                background-color: #F5F5F5;
                border: 2px solid #3F51B5;
                border-radius: 10px;
                padding: 10px;
            }
        """)
        
        self.student_info = QtWidgets.QLabel(self.info_frame)
        self.student_info.setGeometry(QtCore.QRect(10, 10, 780, 60))
        self.student_info.setStyleSheet("""
            QLabel {
                font-family: 'æ¥·ä½“';
                font-size: 14px;
                font-weight: bold;
                color: #1A237E;
                padding: 5px;
                background: transparent;
            }
        """)
        self.student_info.setWordWrap(True)
        
        # è¯¾è¡¨æ˜¾ç¤ºåŒºåŸŸ
        self.schedule_table = QtWidgets.QTableWidget(Dialog)
        self.schedule_table.setGeometry(QtCore.QRect(50, 180, 800, 350))
        self.schedule_table.setObjectName("schedule_table")
        self.schedule_table.setStyleSheet(UI_CONFIG['component_styles']['table'])
        
        # ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ - ä½¿ç”¨QScrollArea
        self.stats_scroll = QtWidgets.QScrollArea(Dialog)
        self.stats_scroll.setGeometry(QtCore.QRect(50, 550, 400, 100))
        self.stats_scroll.setWidgetResizable(True)
        self.stats_scroll.setStyleSheet("""
            QScrollArea {
                background-color: #ffffff;
                border: 2px solid #2196F3;
                border-radius: 10px;
            }
        """)
        
        self.stats_frame = QtWidgets.QFrame()
        self.stats_frame.setStyleSheet("""
            QFrame {
                background-color: #ffffff;
                padding: 10px;
            }
        """)
        
        self.stats_layout = QtWidgets.QVBoxLayout(self.stats_frame)
        self.stats_label = QtWidgets.QLabel()
        self.stats_label.setWordWrap(True)  # å…è®¸æ–‡å­—æ¢è¡Œ
        self.stats_label.setStyleSheet(UI_CONFIG['component_styles']['label'])
        self.stats_layout.addWidget(self.stats_label)
        
        self.stats_scroll.setWidget(self.stats_frame)
        
        # è¯¾ç¨‹åˆ—è¡¨åŒºåŸŸ - ä½¿ç”¨QScrollArea
        self.course_scroll = QtWidgets.QScrollArea(Dialog)
        self.course_scroll.setGeometry(QtCore.QRect(470, 550, 380, 100))
        self.course_scroll.setWidgetResizable(True)
        self.course_scroll.setStyleSheet("""
            QScrollArea {
                background-color: #ffffff;
                border: 2px solid #2196F3;
                border-radius: 10px;
            }
        """)
        
        self.course_list = QtWidgets.QTextBrowser()
        self.course_list.setStyleSheet(UI_CONFIG['component_styles']['text_browser'])
        self.course_scroll.setWidget(self.course_list)
        
        # å¯¼å‡ºå’Œå®ŒæˆæŒ‰é’®
        button_style = """
            QPushButton {
                background-color: #3F51B5;
                border: none;
                border-radius: 5px;
                padding: 5px 10px;
                font-family: 'æ¥·ä½“';
                font-size: 14px;
                font-weight: bold;
                color: white;
            }
            QPushButton:hover {
                background-color: #303F9F;
            }
            QPushButton:pressed {
                background-color: #1A237E;
            }
        """
        
        self.export_button = QtWidgets.QPushButton(Dialog)
        self.export_button.setGeometry(QtCore.QRect(50, 630, 150, 35))
        self.export_button.setObjectName("export_button")
        self.export_button.setText("å¯¼å‡ºè¯¾è¡¨")
        self.export_button.setStyleSheet(button_style)
        
        self.finish_button = QtWidgets.QPushButton(Dialog)
        self.finish_button.setGeometry(QtCore.QRect(730, 630, 120, 35))
        self.finish_button.setObjectName("finish_button")
        self.finish_button.setText("å®Œæˆ")
        self.finish_button.setStyleSheet(button_style)
        
        # èƒŒæ™¯
        self.background = QtWidgets.QLabel(Dialog)
        self.background.setGeometry(QtCore.QRect(0, 0, 900, 700))
        self.background.setText("")
        base_dir = os.path.dirname(os.path.abspath(__file__))
        background_path = os.path.join(base_dir, "res", "èƒŒæ™¯.png")
        if os.path.exists(background_path):
            self.background.setPixmap(QtGui.QPixmap(background_path))
        self.background.setObjectName("background")
        
        # è®¾ç½®z-order
        self.background.raise_()
        self.title_label.raise_()
        self.info_frame.raise_()
        self.schedule_table.raise_()
        self.stats_scroll.raise_()
        self.course_scroll.raise_()
        self.finish_button.raise_()
        self.export_button.raise_()

    def retranslateUi(self, Dialog):
        _translate = QtCore.QCoreApplication.translate
        Dialog.setWindowTitle(_translate("Dialog", "æœ€ç»ˆè¯¾è¡¨"))
        self.title_label.setText(_translate("Dialog", "ğŸ“… æœ€ç»ˆè¯¾ç¨‹è¡¨"))
        self.finish_button.setText(_translate("Dialog", "å®Œæˆ"))
        self.export_button.setText(_translate("Dialog", "å¯¼å‡ºè¯¾è¡¨"))

class FinalDialog(QtWidgets.QDialog, Ui_Dialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setupUi(self)
        self.setWindowTitle("æœ€ç»ˆè¯¾è¡¨")
        
        # åˆ›å»ºè¯¾ç¨‹è°ƒåº¦å™¨
        self.scheduler = CourseScheduler()
        
        # è¿æ¥ä¿¡å·
        self.finish_button.clicked.connect(self.finish_and_exit)
        self.export_button.clicked.connect(self.export_schedule)
        
        # ç”Ÿæˆè¯¾è¡¨
        self.generate_schedule()

    def finish_and_exit(self):
        """å®Œæˆé€‰è¯¾å¹¶é€€å‡ºç¨‹åº"""
        from PyQt5.QtWidgets import QMessageBox, QApplication
        QMessageBox.information(self, "é€‰è¯¾å®Œæˆ", "æ­å–œæ‚¨å®Œæˆé€‰è¯¾ï¼ç¥æ‚¨å­¦ä¹ æ„‰å¿«ï¼")
        self.accept()
        # é€€å‡ºæ•´ä¸ªåº”ç”¨ç¨‹åº
        QApplication.quit()

    def generate_schedule(self):
        """ç”Ÿæˆå®Œæ•´çš„è¯¾ç¨‹è¡¨"""
        try:
            # è·å–ç”¨æˆ·æ•°æ®
            user_data = get_user_data()
            print("\n=== è¯¾ç¨‹æ•°æ®åŠ è½½æƒ…å†µ ===")
            print(f"å¿…ä¿®è¯¾æ•°é‡: {len(user_data.get('compulsory_courses', []))}")
            print(f"é€‰æ‹©æ€§å¿…ä¿®è¯¾æ•°é‡: {len(user_data.get('optional_compulsory_courses', []))}")
            print(f"é€šè¯†è¯¾æ•°é‡: {len(user_data.get('general_courses', []))}")
            print("======================\n")
            
            # æ›´æ–°å­¦ç”Ÿä¿¡æ¯
            age = user_data.get('age', 'æœªçŸ¥')
            major = user_data.get('major', 'æœªçŸ¥')
            total_credits = user_data.get('total_credits', 0)
            
            # æ ¼å¼åŒ–å¹´çº§ä¿¡æ¯
            grade_display = str(age) if age else 'æœªçŸ¥'
            
            student_info_text = f"å­¦ç”Ÿï¼š{grade_display} {major} | " \
                              f"æ€»å­¦åˆ†ï¼š{total_credits} | " \
                              f"é€‰è¯¾çŠ¶æ€ï¼šå·²å®Œæˆ"
            self.student_info.setText(student_info_text)
            
            # æ”¶é›†æ‰€æœ‰è¯¾ç¨‹
            all_courses = []
            used_time_slots = set()
            default_times = [
                "å‘¨ä¸€1-2èŠ‚", "å‘¨ä¸€3-4èŠ‚", "å‘¨ä¸€5-6èŠ‚", "å‘¨ä¸€7-8èŠ‚",
                "å‘¨äºŒ1-2èŠ‚", "å‘¨äºŒ3-4èŠ‚", "å‘¨äºŒ5-6èŠ‚", "å‘¨äºŒ7-8èŠ‚",
                "å‘¨ä¸‰1-2èŠ‚", "å‘¨ä¸‰3-4èŠ‚", "å‘¨ä¸‰5-6èŠ‚", "å‘¨ä¸‰7-8èŠ‚",
                "å‘¨å››1-2èŠ‚", "å‘¨å››3-4èŠ‚", "å‘¨å››5-6èŠ‚", "å‘¨å››7-8èŠ‚",
                "å‘¨äº”1-2èŠ‚", "å‘¨äº”3-4èŠ‚", "å‘¨äº”5-6èŠ‚", "å‘¨äº”7-8èŠ‚"
            ]
            default_time_idx = 0

            def assign_time(course_dict):
                nonlocal default_time_idx
                # å¦‚æœæ²¡æœ‰ä¸Šè¯¾æ—¶é—´ï¼Œè‡ªåŠ¨åˆ†é…
                if not course_dict.get('time') and not course_dict.get('ä¸Šè¯¾æ—¶é—´'):
                    # æ‰¾åˆ°ä¸€ä¸ªæœªè¢«å ç”¨çš„æ—¶é—´æ®µ
                    while default_time_idx < len(default_times):
                        t = default_times[default_time_idx]
                        default_time_idx += 1
                        if t not in used_time_slots:
                            course_dict['time'] = t
                            used_time_slots.add(t)
                            break
                else:
                    # æ ‡è®°å·²ç”¨æ—¶é—´
                    t = course_dict.get('time') or course_dict.get('ä¸Šè¯¾æ—¶é—´')
                    used_time_slots.add(t)
                return course_dict

            # å¿…ä¿®è¯¾
            compulsory_courses = user_data.get("compulsory_courses", [])
            print("\n=== å¿…ä¿®è¯¾åŠ è½½ ===")
            for course in compulsory_courses:
                course_with_type = course.copy()
                course_with_type['course_type'] = "å¿…ä¿®è¯¾"
                course_with_type = assign_time(course_with_type)
                course_obj = create_course_from_dict(course_with_type)
                all_courses.append(course_obj)
                self.scheduler.add_selected_course(course_obj)
                print(f"æ·»åŠ å¿…ä¿®è¯¾: {course_obj.name}")

            # é€‰æ‹©æ€§å¿…ä¿®è¯¾
            optional_courses = user_data.get("optional_compulsory_courses", [])
            print("\n=== é€‰æ‹©æ€§å¿…ä¿®è¯¾åŠ è½½ ===")
            for course in optional_courses:
                course_with_type = course.copy()
                course_with_type['course_type'] = "é€‰æ‹©æ€§å¿…ä¿®è¯¾"
                course_with_type = assign_time(course_with_type)
                course_obj = create_course_from_dict(course_with_type)
                all_courses.append(course_obj)
                self.scheduler.add_selected_course(course_obj)
                print(f"æ·»åŠ é€‰æ‹©æ€§å¿…ä¿®è¯¾: {course_obj.name}")

            # é€šè¯†è¯¾
            general_courses = user_data.get("general_courses", [])
            print("\n=== é€šè¯†è¯¾åŠ è½½ ===")
            for course in general_courses:
                course_with_type = course.copy()
                course_with_type['course_type'] = "é€šè¯†è¯¾"
                course_with_type = assign_time(course_with_type)
                course_obj = create_course_from_dict(course_with_type)
                all_courses.append(course_obj)
                self.scheduler.add_selected_course(course_obj)
                print(f"æ·»åŠ é€šè¯†è¯¾: {course_obj.name}")
            
            print(f"\næ€»è¯¾ç¨‹æ•°: {len(all_courses)}")
            print(f"è°ƒåº¦å™¨ä¸­è¯¾ç¨‹æ•°: {len(self.scheduler.selected_courses)}")

            # åˆ›å»ºè¯¾è¡¨
            self.create_schedule_table()
            
            # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            self.update_statistics(all_courses)
            
            # æ›´æ–°è¯¾ç¨‹åˆ—è¡¨
            self.update_course_list(all_courses)
            
        except Exception as e:
            print(f"ç”Ÿæˆè¯¾è¡¨æ—¶å‡ºé”™: {e}")
            import traceback
            traceback.print_exc()
            
            # å¦‚æœæ²¡æœ‰è¯¾ç¨‹æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if not any([
                user_data.get("compulsory_courses"),
                user_data.get("optional_compulsory_courses"), 
                user_data.get("general_courses")
            ]):
                self.student_info.setText("æš‚æ— è¯¾ç¨‹æ•°æ®ï¼Œè¯·é‡æ–°è¿›è¡Œé€‰è¯¾")
                # åœ¨è¯¾è¡¨ä¸­æ˜¾ç¤ºæç¤º
                item = QtWidgets.QTableWidgetItem("æš‚æ— è¯¾ç¨‹æ•°æ®\nè¯·é‡æ–°è¿›è¡Œé€‰è¯¾")
                item.setTextAlignment(QtCore.Qt.AlignCenter)
                self.schedule_table.setRowCount(1)
                self.schedule_table.setColumnCount(1)
                self.schedule_table.setItem(0, 0, item)

    def create_schedule_table(self):
        """åˆ›å»ºè¯¾ç¨‹è¡¨æ ¼"""
        # è®¾ç½®è¡¨æ ¼åŸºæœ¬å±æ€§
        self.schedule_table.clear()
        self.schedule_table.setRowCount(12)
        self.schedule_table.setColumnCount(6)
        
        # è®¾ç½®è¡¨å¤´
        headers = ['æ—¶é—´', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”']
        self.schedule_table.setHorizontalHeaderLabels(headers)
        
        # è®¾ç½®è¡¨å¤´æ ·å¼
        self.schedule_table.horizontalHeader().setStyleSheet("""
            QHeaderView::section {
                background-color: #3F51B5;
                color: white;
                font-family: 'æ¥·ä½“';
                font-size: 12px;
                font-weight: bold;
                padding: 4px;
                border: none;
            }
        """)
        
        # è®¾ç½®æ—¶é—´æ®µ
        time_slots = [
            'ç¬¬1èŠ‚ (8:00-8:50)', 'ç¬¬2èŠ‚ (9:00-9:50)',
            'ç¬¬3èŠ‚ (10:10-11:00)', 'ç¬¬4èŠ‚ (11:10-12:00)',
            'ç¬¬5èŠ‚ (13:00-13:50)', 'ç¬¬6èŠ‚ (14:00-14:50)',
            'ç¬¬7èŠ‚ (15:10-16:00)', 'ç¬¬8èŠ‚ (16:10-17:00)',
            'ç¬¬9èŠ‚ (17:10-18:00)', 'ç¬¬10èŠ‚ (18:40-19:30)',
            'ç¬¬11èŠ‚ (19:40-20:30)', 'ç¬¬12èŠ‚ (20:40-21:30)'
        ]
        
        # è®¾ç½®æ—¶é—´åˆ—å®½åº¦å’Œæ ·å¼
        self.schedule_table.setColumnWidth(0, 150)  # åŠ å®½æ—¶é—´åˆ—
        
        # è®¾ç½®æ—¶é—´åˆ—
        for i, time_slot in enumerate(time_slots):
            item = QtWidgets.QTableWidgetItem(time_slot)
            item.setTextAlignment(QtCore.Qt.AlignCenter)
            # ä¸ºæ—¶é—´åˆ—è®¾ç½®ç‰¹æ®Šå­—ä½“å’Œæ ·å¼
            font = QtGui.QFont('Microsoft YaHei', 9)  # ä½¿ç”¨é›…é»‘å­—ä½“ï¼Œæ›´é€‚åˆæ˜¾ç¤ºæ•°å­—
            font.setBold(True)
            item.setFont(font)
            item.setBackground(QtGui.QColor('#E8EAF6'))  # æµ…è‰²èƒŒæ™¯
            item.setForeground(QtGui.QColor('#1A237E'))  # æ·±è‰²æ–‡å­—
            self.schedule_table.setItem(i, 0, item)
        
        # è¯¾ç¨‹ç±»å‹å¯¹åº”çš„é¢œè‰² - ä½¿ç”¨æ›´æŸ”å’Œçš„é…è‰²
        course_colors = {
            'å¿…ä¿®è¯¾': '#E3F2FD',  # æµ…è“è‰²
            'é€‰æ‹©æ€§å¿…ä¿®è¯¾': '#F3E5F5',  # æµ…ç´«è‰²
            'é€šè¯†è¯¾': '#E8F5E9'  # æµ…ç»¿è‰²
        }
        
        # è·å–è¯¾ç¨‹è¡¨çŸ©é˜µ
        schedule_matrix = self.scheduler.get_schedule_matrix()
        
        # å¡«å……è¯¾ç¨‹
        for row in range(12):
            for col in range(1, 6):  # è·³è¿‡æ—¶é—´åˆ—
                course_name = schedule_matrix[row][col-1]
                if course_name:
                    course = next(
                        (c for c in self.scheduler.selected_courses if c.name == course_name),
                        None
                    )
                    
                    if course:
                        item = QtWidgets.QTableWidgetItem(course.name)
                        item.setTextAlignment(QtCore.Qt.AlignCenter)
                        # ä¸ºè¯¾ç¨‹è®¾ç½®å­—ä½“
                        font = QtGui.QFont('æ¥·ä½“', 10)
                        item.setFont(font)
                        
                        # è®¾ç½®èƒŒæ™¯è‰²å’Œæ–‡å­—é¢œè‰²
                        item.setBackground(QtGui.QColor(course_colors.get(course.course_type, '#FFFFFF')))
                        item.setForeground(QtGui.QColor('#333333'))  # æ·±ç°è‰²æ–‡å­—
                        
                        tooltip = (
                            f"è¯¾ç¨‹ï¼š{course.name}\n"
                            f"æ•™å¸ˆï¼š{course.teacher}\n"
                            f"åœ°ç‚¹ï¼š{course.location}\n"
                            f"å­¦åˆ†ï¼š{course.credit}\n"
                            f"ç±»å‹ï¼š{course.course_type}"
                        )
                        item.setToolTip(tooltip)
                        
                        self.schedule_table.setItem(row, col, item)
        
        # è°ƒæ•´è¡Œé«˜
        for i in range(self.schedule_table.rowCount()):
            self.schedule_table.setRowHeight(i, 40)
        
        # è®¾ç½®è¡¨æ ¼æ•´ä½“æ ·å¼
        self.schedule_table.setStyleSheet("""
            QTableWidget {
                background-color: white;
                gridline-color: #E0E0E0;
                border: 1px solid #BDBDBD;
                border-radius: 5px;
            }
            QTableWidget::item {
                border: 1px solid #E0E0E0;
                border-radius: 2px;
            }
            QTableWidget::item:selected {
                background-color: #E8EAF6;
            }
        """)

    def update_statistics(self, courses):
        """æ›´æ–°ç»Ÿè®¡ä¿¡æ¯"""
        total_credits = sum(course.credit for course in courses)
        course_types = {}
        for course in courses:
            course_type = course.course_type
            course_types[course_type] = course_types.get(course_type, 0) + 1
        
        stats_text = (
            f"æ€»è¯¾ç¨‹æ•°ï¼š{len(courses)}é—¨\n"
            f"æ€»å­¦åˆ†ï¼š{total_credits}åˆ†\n"
            f"è¯¾ç¨‹ç±»å‹åˆ†å¸ƒï¼š\n"
        )
        for course_type, count in course_types.items():
            stats_text += f"  {course_type}: {count}é—¨\n"
        
        self.stats_label.setText(stats_text)

    def update_course_list(self, courses):
        """æ›´æ–°è¯¾ç¨‹åˆ—è¡¨"""
        course_list_text = "è¯¾ç¨‹åˆ—è¡¨ï¼š\n\n"
        
        # æŒ‰ç±»å‹åˆ†ç»„è¯¾ç¨‹
        course_by_type = {}
        for course in courses:
            course_type = course.course_type
            if course_type not in course_by_type:
                course_by_type[course_type] = []
            course_by_type[course_type].append(course)
        
        # æŒ‰ç±»å‹æ˜¾ç¤ºè¯¾ç¨‹
        for course_type, type_courses in course_by_type.items():
            course_list_text += f"ã€{course_type}ã€‘\n"
            for course in type_courses:
                course_list_text += (
                    f"â€¢ {course.name} ({course.credit}å­¦åˆ†)\n"
                    f"  æ•™å¸ˆï¼š{course.teacher}\n"
                    f"  æ—¶é—´ï¼š{course.time}\n"
                    f"  åœ°ç‚¹ï¼š{course.location}\n\n"
                )
        
        self.course_list.setText(course_list_text)

    def export_schedule(self):
        """å¯¼å‡ºè¯¾è¡¨"""
        try:
            # ç”ŸæˆHTMLæ ¼å¼çš„è¯¾è¡¨
            html_content = self.generate_html_schedule()
            
            # è·å–å½“å‰æ—¶é—´ä½œä¸ºæ–‡ä»¶å
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"è¯¾è¡¨_{timestamp}.html"
            
            # ä¿å­˜æ–‡ä»¶
            file_path, _ = QtWidgets.QFileDialog.getSaveFileName(
                self,
                "ä¿å­˜è¯¾è¡¨",
                filename,
                "HTML Files (*.html);;All Files (*)"
            )
            
            if file_path:
                # ç¡®ä¿æ–‡ä»¶è·¯å¾„æœ‰.htmlåç¼€
                if not file_path.lower().endswith('.html'):
                    file_path += '.html'
                
                # ä½¿ç”¨UTF-8ç¼–ç ä¿å­˜æ–‡ä»¶
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(html_content)
                QtWidgets.QMessageBox.information(
                    self,
                    "å¯¼å‡ºæˆåŠŸ",
                    f"è¯¾è¡¨å·²æˆåŠŸå¯¼å‡ºåˆ°ï¼š\n{file_path}"
                )
        
        except Exception as e:
            import traceback
            error_msg = f"å¯¼å‡ºè¯¾è¡¨æ—¶å‡ºé”™ï¼š\n{str(e)}\n\nè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n{traceback.format_exc()}"
            print(error_msg)  # æ‰“å°è¯¦ç»†é”™è¯¯ä¿¡æ¯åˆ°æ§åˆ¶å°
            QtWidgets.QMessageBox.warning(
                self,
                "å¯¼å‡ºå¤±è´¥",
                f"å¯¼å‡ºè¯¾è¡¨æ—¶å‡ºé”™ï¼š\n{str(e)}"
            )

    def generate_html_schedule(self):
        """ç”ŸæˆHTMLæ ¼å¼çš„è¯¾è¡¨"""
        html_template = """
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>è¯¾ç¨‹è¡¨</title>
            <style>
                body { font-family: 'æ¥·ä½“', sans-serif; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid black; padding: 8px; text-align: center; }
                th { background-color: #f2f2f2; }
                .course-å¿…ä¿®è¯¾ { background-color: #FFE4E1; }
                .course-é€‰æ‹©æ€§å¿…ä¿®è¯¾ { background-color: #E0FFFF; }
                .course-é€šè¯†è¯¾ { background-color: #F0FFF0; }
                .info { margin: 20px 0; }
                .header { text-align: center; margin: 20px 0; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>è¯¾ç¨‹è¡¨</h1>
                <p>{student_info}</p>
            </div>
            <table>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>å‘¨ä¸€</th>
                    <th>å‘¨äºŒ</th>
                    <th>å‘¨ä¸‰</th>
                    <th>å‘¨å››</th>
                    <th>å‘¨äº”</th>
                </tr>
                {table_content}
            </table>
            <div class="info">
                <h2>ç»Ÿè®¡ä¿¡æ¯</h2>
                {stats_info}
            </div>
            <div class="info">
                <h2>è¯¾ç¨‹åˆ—è¡¨</h2>
                {course_list}
            </div>
        </body>
        </html>
        """
        
        # è·å–è¡¨æ ¼å†…å®¹
        table_content = ""
        for row in range(self.schedule_table.rowCount()):
            table_content += "<tr>"
            for col in range(self.schedule_table.columnCount()):
                item = self.schedule_table.item(row, col)
                if item:
                    cell_content = item.text().replace('\n', '<br>')
                    cell_class = ""
                    if col > 0:  # ä¸æ˜¯æ—¶é—´åˆ—
                        tooltip = item.toolTip()
                        if "ç±»å‹ï¼š" in tooltip:
                            course_type = tooltip.split("ç±»å‹ï¼š")[1].split("\n")[0]
                            cell_class = f' class="course-{course_type}"'
                    table_content += f"<td{cell_class}>{cell_content}</td>"
                else:
                    table_content += "<td></td>"
            table_content += "</tr>"
        
        # ç”Ÿæˆå®Œæ•´çš„HTML
        html_content = html_template.format(
            student_info=self.student_info.text(),
            table_content=table_content,
            stats_info=self.stats_label.text().replace('\n', '<br>'),
            course_list=self.course_list.toPlainText().replace('\n', '<br>')
        )
        
        return html_content
